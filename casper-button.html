<link rel="import" href="casper-button-actions.html">
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../vaadin-progress-bar/vaadin-progress-bar.html">

<custom-style>
  <style>
    html {
      --smooth-action: {
        -webkit-transition: all 0.2s;
        -o-transition: all 0.2s;
        transition: all 0.2s;
      }

      --smooth-action-hover: {
        -webkit-transition: all 0.5s;
        -o-transition: all 0.5s;
        transition: all 0.5s;
      }

      --mixin-button: {
        margin: 12px;
        height: 36px;
        font-weight: 900;
        text-align: center;
        -webkit-font-smoothing: antialiased;
        color: var(--on-primary-color, white);
        border-radius: var(--radius-buttons, 3px);
        font-size: var(--default-button-size, 14px);
        background-color: var(--primary-color, red);
        @apply --smooth-action;
      }

      --mixin-button-hover: {
        background-color: var(--primary-variant-color, green);
        @apply --smooth-action-hover;
      }
    }
  </style>
</custom-style>

<dom-module id="casper-button">
  <template>
    <style>
      :host {
        display: flex;
        margin: 0 10px 4px 0;
        --lumo-border-radius: 0;
        --lumo-primary-color: var(--primary-color);
      }

      paper-button {
        margin: 0 !important;
        padding: 0;
        width: 100%;
        overflow: hidden;
        position: relative;
        background-color: var(--self-primary-color, var(--primary-color, green));
        @apply --mixin-button;
      }

      paper-button:hover {
        background-color: var(--self-primary-variant-color, var(--primary-variant-color, green));
        @apply --mixin-button-hover;
      }

      :host([disabled]) {
        pointer-events: none;
      }

      paper-button[disabled] {
        cursor: auto;
        color: #A8A8A8;
        background: #EAEAEA;
        pointer-events: none;
        transition: background-color 0.5s;
      }

      vaadin-progress-bar {
        top: 0;
        left: 0;
        margin: 0;
        height: 36px;
        display: none;
        position: absolute;
      }

      paper-button paper-spinner-lite {
        left: 0;
        right: 0;
        width: 22px;
        height: 22px;
        margin-left: auto;
        margin-right: auto;
        position: absolute;
        --paper-spinner-color: white;
        --paper-spinner-stroke-width: 4px;
      }

      paper-button {
        width: auto;
      }

      paper-button#mainButton {
        padding: 0 15px;
      }

      paper-button#actionsButton {
        font-size: 13px;
        min-width: unset;
        padding: 0 10px;
        border-radius: 0 3px 3px 0;
      }

      paper-button #buttonText {
        line-height: 36px;
      }

      paper-button #buttonText.small {
        line-height: 24px;
      }

      paper-button.small {
        height: 24px;
      }

      paper-button.decline-button {
        background: #BDBDBD;
      }

      paper-button.decline-button:hover {
        background-color: #8E8E8E;
      }

      ::slotted(a) {
        color: white;
        text-decoration: none;
      }
    </style>
    <paper-button
      id="mainButton"
      class$="[[sizeClass]]"
      on-click="_mainButtonClicked">
      <span id="buttonText" class$="text [[sizeClass]]">
        <slot>Concordo e aceito</slot>
      </span>
      <vaadin-progress-bar value="0" id="progressBar"></vaadin-progress-bar>
      <paper-spinner-lite id="spin"></paper-spinner-lite>
    </paper-button>
    <template is="dom-if" if="[[actions]]">
      <paper-button id="actionsButton" on-click="_actionsButtonClicked">&#x25BC;</paper-button>
        <casper-button-actions
          actions="[[actions]]"
          no-overlap
          vertical-align="top"
          horizontal-align="right">
        </casper-button-actions>
    </template>
  </template>

  <script>
    /**
     * `casper-button`
     * click, click, click...
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperButton extends Polymer.Element {
      static get is () {
        return 'casper-button';
      }

      static get properties() {
        return {
          size: {
            type: String,
            value: 'm'
          },
          progress: {
            type: String,
            value: 0,
            observer: '_progressChanged'
          },
          disabled: {
            type: Boolean,
            observer: '_disabledChanged'
          },
          cssClass: {
            type: String
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
      }

      ready() {
        super.ready();
        if (this.css_class) {
          this.shadowRoot.querySelector('paper-button').classList.add(this.cssClass);
        }

        this.sizeClass = this.size == 's' ? 'small' : '';
        this.spinnerTimer = undefined;

        // Remove the default margin.
        if (this.hasAttribute('no-container-margin')) this.style.margin = 0;

        // Used an attribute and not the this.actions.length > 0 to avoid Polymer.RenderStatus and further blinking.
        if (this.hasAttribute('has-actions')) this.$.mainButton.style.borderRadius = '3px 0 0 3px';
      }

      _disabledChanged (newValue) {
        this.$.mainButton.disabled = newValue;
      }

      _progressChanged (newValue) {
        if (newValue == 0) {
          this.submitting(false);
          this.$.progressBar.style.display = 'none';
        } else {
          this.$.progressBar.style.display = 'block';
        }

        this.$.progressBar.value = newValue / 100;
      }


      submitting (status) {
        this.disableButton(status);

        if (status == true) {
          this.spinnerTimer = setTimeout(() => this.spinButton(status), 200);
          this.$.buttonText.style.opacity = 0;
        } else {
          this.progress = 0;
          if (this.spinnerTimer) {
            clearTimeout(this.spinnerTimer);
          }

          this.spinButton(status);
          this.$.buttonText.style.opacity = 1;
        }

        window.dispatchEvent(new CustomEvent('casper-button-status', { detail: { target: this, submitting: status } }));
      }

      disableButton (status) {
        this.$.mainButton.disabled = status;
      }

      spinButton (status) {
        this.$.spin.active = status;
      }

      _mainButtonClicked (event) {
        if (this.$.mainButton.disabled) {
          event.stopImmediatePropagation();
          return;
        }

        const anchorElement = this.querySelector('a');
        if (anchorElement && anchorElement.link.getAttribute('href')) {
          this.submitting(true);
        }
      }

      _actionsButtonClicked (event) {
        // Prevent the event from bubbling up.
        event.stopImmediatePropagation();

        this._buttonActions = this._casperButtonActions || this.shadowRoot.querySelector('casper-button-actions');
        this._buttonActions.positionTarget = event.target;
        this._buttonActions.open();
      }
    }

    window.customElements.define(CasperButton.is, CasperButton);
  </script>
</dom-module>
